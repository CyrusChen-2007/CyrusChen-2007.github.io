<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>First Five | Connected Classroom</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <!-- Libraries -->
    <script src="https://unpkg.com/peerjs@1.5.1/dist/peerjs.min.js"></script>

    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
            --text-main: #2d3436;
            --accent: #6c5ce7; 
            --accent-light: #a29bfe;
            --thread-color: #b2bec3;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: var(--bg-gradient);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            width: 100vw; height: 100vh;
        }

        /* --- LAYOUT --- */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.5s ease;
            z-index: 10;
        }
        .screen.active { opacity: 1; pointer-events: auto; }

        h1 { font-family: 'DM Serif Display', serif; font-size: 3.5rem; margin-bottom: 1rem; }
        
        .card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            padding: 3rem; border-radius: 24px;
            border: 1px solid white;
            box-shadow: 0 20px 40px rgba(0,0,0,0.05);
            display: flex; flex-direction: column; align-items: center; gap: 1.5rem;
            max-width: 500px; width: 90%;
            text-align: center;
        }

        input, textarea {
            background: rgba(255,255,255,0.6); border: 1px solid rgba(0,0,0,0.1);
            border-radius: 12px; padding: 12px; font-size: 1rem; width: 100%;
            font-family: inherit; outline: none; transition: 0.3s;
        }
        input:focus, textarea:focus { background: white; border-color: var(--accent); }
        textarea { height: 120px; resize: none; }

        button {
            background: var(--text-main); color: white; border: none;
            padding: 12px 30px; border-radius: 50px; font-size: 1rem; font-weight: 600;
            cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        button.secondary { background: white; color: var(--text-main); border: 1px solid #ddd; }

        /* --- BUBBLE UNIVERSE --- */
        #universe-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 20; pointer-events: none; /* Bubbles handle their own events */
        }
        
        #thread-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 15; pointer-events: none;
        }

        .bubble {
            position: absolute;
            width: fit-content; max-width: 280px; min-width: 120px;
            padding: 18px;
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.05);
            text-align: left;
            pointer-events: auto;
            transform-origin: center;
            will-change: transform, left, top;
            display: flex; flex-direction: column; gap: 8px;
            transition: background 0.3s, border 0.3s;
        }

        .bubble-text { font-size: 0.95rem; line-height: 1.4; color: #2d3436; word-wrap: break-word; }
        .bubble-meta { 
            display: flex; justify-content: space-between; align-items: center; 
            font-size: 0.75rem; color: #636e72; border-top: 1px solid rgba(0,0,0,0.05); 
            padding-top: 8px; margin-top: 4px;
        }
        .bubble-author { font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--accent); }
        
        /* Actions */
        .bubble-actions { display: flex; gap: 10px; }
        .action-btn { 
            cursor: pointer; display: flex; align-items: center; gap: 4px; 
            transition: color 0.2s; background: none; border: none; padding: 0; color: #b2bec3; font-size: 0.8rem;
        }
        .action-btn:hover { color: var(--accent); }
        .action-btn.liked { color: #e17055; }

        /* Reply Style */
        .bubble.reply {
            background: rgba(240, 240, 255, 0.7);
            border-color: var(--accent-light);
            font-size: 0.9rem;
            max-width: 220px;
        }

        /* Selected / Roulette Style */
        .bubble.highlight { border: 2px solid var(--accent); background: white; z-index: 100; transform: scale(1.1); }
        .bubble.winner { 
            border: 3px solid var(--accent); 
            background: white; 
            box-shadow: 0 0 60px rgba(108, 92, 231, 0.4);
            z-index: 200;
        }

        /* --- DASHBOARD UI OVERLAYS --- */
        .hud {
            position: fixed; z-index: 50; padding: 20px;
            background: rgba(255,255,255,0.8); backdrop-filter: blur(10px);
            border-radius: 16px; border: 1px solid white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
        }
        .hud-top { top: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 20px; align-items: center; }
        .hud-bottom { bottom: 30px; left: 50%; transform: translateX(-50%); }

        /* Reply Modal */
        #reply-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.2); backdrop-filter: blur(5px);
            z-index: 1000; display: none; align-items: center; justify-content: center;
        }

    </style>
</head>
<body>

    <!-- Thread Drawing Layer -->
    <canvas id="thread-canvas"></canvas>
    
    <!-- Bubbles Container -->
    <div id="universe-layer"></div>

    <!-- 1. LANDING -->
    <div id="screen-landing" class="screen active">
        <div class="card">
            <h1>First Five</h1>
            <p>Interactive Literature Response Tool</p>
            <div style="display: flex; gap: 15px; margin-top: 20px;">
                <button onclick="initTeacher()">Host Class</button>
                <button class="secondary" onclick="router('student-login')">Join Class</button>
            </div>
        </div>
    </div>

    <!-- 2. STUDENT LOGIN -->
    <div id="screen-student-login" class="screen">
        <div class="card">
            <h2>Join Room</h2>
            <input type="text" id="join-code" placeholder="4-Digit Code" maxlength="4" style="text-align: center; font-size: 1.5rem; letter-spacing: 4px;">
            <input type="text" id="student-name" placeholder="Your Name">
            <button onclick="joinSession()">Enter</button>
            <button class="secondary" onclick="router('landing')">Back</button>
        </div>
    </div>

    <!-- 3. STUDENT WRITING DESK (Initial) -->
    <div id="screen-writing" class="screen">
        <div class="card">
            <h3 style="color: var(--accent); text-transform: uppercase; font-size: 0.8rem;">Current Prompt</h3>
            <h2 id="student-prompt-view" style="font-family: 'DM Serif Display'; font-size: 1.5rem;">Waiting for teacher...</h2>
            <textarea id="student-response" placeholder="Write your response..."></textarea>
            <button onclick="submitResponse()">Publish to Class</button>
        </div>
    </div>

    <!-- 4. SHARED UNIVERSE VIEW (Teacher & Student) -->
    <div id="screen-universe" class="screen">
        
        <!-- Teacher Controls -->
        <div id="teacher-hud" class="hud hud-top" style="display: none;">
            <div>
                <span style="font-size: 0.8rem; color: #888; text-transform: uppercase;">Code</span>
                <strong id="display-code" style="font-size: 1.5rem; color: var(--accent); margin-left: 5px;">----</strong>
            </div>
            <div style="width: 1px; height: 30px; background: #ddd;"></div>
            <input type="text" id="teacher-input" placeholder="Set Prompt..." style="width: 250px;">
            <button class="secondary" style="padding: 8px 15px;" onclick="broadcastPrompt()">Set</button>
            <div style="width: 1px; height: 30px; background: #ddd;"></div>
            <button style="padding: 10px 25px;" onclick="startRoulette()">✦ Random Pick</button>
        </div>

        <!-- Student HUD (Minimal) -->
        <div id="student-hud" class="hud hud-bottom" style="display: none;">
            Viewing Class Responses
        </div>

    </div>

    <!-- Reply Modal -->
    <div id="reply-modal">
        <div class="card">
            <h3>Reply to <span id="reply-target-name">...</span></h3>
            <textarea id="reply-input" placeholder="Your thoughts..."></textarea>
            <div style="display: flex; gap: 10px; width: 100%;">
                <button onclick="sendReply()" style="flex: 1;">Post Reply</button>
                <button class="secondary" onclick="closeReplyModal()" style="flex: 1;">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG & STATE ---
        const APP_ID = 'inkwell-v4-';
        let myPeer, myId;
        let role = 'student'; // 'teacher' or 'student'
        let connections = []; // Teacher: list of student conns
        let hostConn = null;  // Student: conn to teacher
        
        // Data Store (Synced)
        let bubbles = []; 
        let currentPrompt = "";
        
        // Physics Engine
        let physicsLoopId;
        const canvas = document.getElementById('thread-canvas');
        const ctx = canvas.getContext('2d');
        let width, height;

        // Interaction State
        let activeReplyParentId = null;

        // --- ROUTING ---
        function router(screen) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(`screen-${screen}`).classList.add('active');
        }

        // --- RESIZE HANDLER ---
        function resize() {
            width = window.innerWidth;
            height = window.innerHeight;
            canvas.width = width;
            canvas.height = height;
        }
        window.addEventListener('resize', resize);
        resize();

        // --- TEACHER LOGIC ---
        function initTeacher() {
            role = 'teacher';
            const code = Math.floor(1000 + Math.random() * 9000).toString();
            myPeer = new Peer(APP_ID + code);

            myPeer.on('open', (id) => {
                myId = id;
                document.getElementById('display-code').innerText = code;
                document.getElementById('teacher-hud').style.display = 'flex';
                router('universe');
                startPhysicsLoop(); // Teacher runs physics
            });

            myPeer.on('connection', (conn) => {
                connections.push(conn);
                conn.on('data', (data) => handleServerData(data, conn));
                
                // Sync new student
                setTimeout(() => {
                    conn.send({ type: 'SYNC_FULL', bubbles: bubbles, prompt: currentPrompt });
                }, 500);
            });
        }

        function handleServerData(data, conn) {
            // Central Hub for Logic
            if(data.type === 'SUBMIT') {
                createBubble(data.text, data.author, null); // Parent null = root
            }
            if(data.type === 'REPLY') {
                createBubble(data.text, data.author, data.parentId);
            }
            if(data.type === 'LIKE') {
                const b = bubbles.find(b => b.id === data.id);
                if(b) {
                    b.likes++;
                    broadcastState();
                }
            }
        }

        function broadcastPrompt() {
            currentPrompt = document.getElementById('teacher-input').value;
            broadcast({ type: 'PROMPT', text: currentPrompt });
        }

        function broadcastState() {
            // Teacher sends minimal physics/data update
            // For smoother visual on student side, we send x/y targets
            const payload = bubbles.map(b => ({
                id: b.id, x: b.x, y: b.y, 
                text: b.text, author: b.author, 
                likes: b.likes, parentId: b.parentId,
                isWinner: b.isWinner
            }));
            broadcast({ type: 'SYNC_TICK', bubbles: payload });
        }

        function broadcast(msg) {
            connections.forEach(c => c.send(msg));
        }

        // --- STUDENT LOGIC ---
        function joinSession() {
            const code = document.getElementById('join-code').value;
            const name = document.getElementById('student-name').value;
            if(!code || !name) return alert("Missing Code/Name");
            
            // Store name globally
            window.studentName = name;

            myPeer = new Peer();
            myPeer.on('open', () => {
                hostConn = myPeer.connect(APP_ID + code);
                hostConn.on('open', () => {
                    router('writing');
                });
                hostConn.on('data', handleClientData);
            });
        }

        function handleClientData(data) {
            if(data.type === 'PROMPT') {
                document.getElementById('student-prompt-view').innerText = data.text;
            }
            if(data.type === 'SYNC_FULL') {
                // Initial Load
                currentPrompt = data.prompt;
                document.getElementById('student-prompt-view').innerText = currentPrompt;
                // Reconstruct bubbles locally
                data.bubbles.forEach(remoteB => {
                   if(!bubbles.find(b => b.id === remoteB.id)) {
                       spawnLocalBubble(remoteB);
                   } 
                });
            }
            if(data.type === 'SYNC_TICK') {
                // Smooth Sync
                data.bubbles.forEach(remoteB => {
                    let localB = bubbles.find(b => b.id === remoteB.id);
                    if(!localB) {
                        spawnLocalBubble(remoteB);
                    } else {
                        // Lerp towards teacher position
                        localB.targetX = remoteB.x;
                        localB.targetY = remoteB.y;
                        localB.likes = remoteB.likes;
                        localB.isWinner = remoteB.isWinner; // Sync winner status
                        updateBubbleDOM(localB);
                    }
                });
            }
        }

        function submitResponse() {
            const txt = document.getElementById('student-response').value;
            if(!txt) return;
            hostConn.send({ type: 'SUBMIT', text: txt, author: window.studentName });
            
            // Switch view
            router('universe');
            document.getElementById('student-hud').style.display = 'block';
            startClientPhysics(); // Client interpolation loop
        }

        // --- SHARED PHYSICS & BUBBLE LOGIC ---

        function createBubble(text, author, parentId) {
            // Only Teacher creates the "True" bubble instance
            const id = Date.now() + Math.random().toString();
            
            // Spawn Position: If reply, near parent. If new, random side.
            let startX, startY;
            
            if (parentId) {
                const parent = bubbles.find(b => b.id === parentId);
                startX = parent ? parent.x + (Math.random()-0.5)*50 : width/2;
                startY = parent ? parent.y + 50 : height/2;
            } else {
                // Spawn from random side angle
                const angle = Math.random() * Math.PI * 2;
                const dist = Math.min(width, height) / 2 + 100;
                startX = width/2 + Math.cos(angle) * dist;
                startY = height/2 + Math.sin(angle) * dist;
            }

            const newBubble = {
                id, text, author, parentId,
                x: startX, y: startY,
                vx: 0, vy: 0,
                radius: 60, // approximate, updated by DOM
                likes: 0,
                isWinner: false
            };
            
            bubbles.push(newBubble);
            spawnBubbleDOM(newBubble); // Teacher's DOM
            broadcastState(); // Tell everyone
        }

        function spawnLocalBubble(data) {
            // Students create a local copy
            const b = { ...data, vx:0, vy:0, targetX: data.x, targetY: data.y };
            bubbles.push(b);
            spawnBubbleDOM(b);
        }

        function spawnBubbleDOM(b) {
            const el = document.createElement('div');
            el.className = b.parentId ? 'bubble reply' : 'bubble';
            el.id = 'dom-' + b.id;
            
            const content = `
                <div class="bubble-text">${b.text}</div>
                <div class="bubble-meta">
                    <span class="bubble-author">${b.author}</span>
                    <div class="bubble-actions">
                        <button class="action-btn" onclick="sendLike('${b.id}')">
                            ♥ <span id="likes-${b.id}">${b.likes}</span>
                        </button>
                        <button class="action-btn" onclick="openReply('${b.id}', '${b.author}')">
                            ↰ Reply
                        </button>
                    </div>
                </div>
            `;
            el.innerHTML = content;
            document.getElementById('universe-layer').appendChild(el);
            
            // Update radius based on real size
            const rect = el.getBoundingClientRect();
            b.radius = Math.max(rect.width, rect.height) / 2 + 10;
        }

        function updateBubbleDOM(b) {
            const el = document.getElementById('dom-' + b.id);
            if(!el) return;
            
            // Update Pos
            if(role === 'student') {
                // Client side interpolation
                b.x += (b.targetX - b.x) * 0.1;
                b.y += (b.targetY - b.y) * 0.1;
            }

            el.style.left = (b.x - b.radius + 10) + 'px'; // Center alignment offset approx
            el.style.top = (b.y - b.radius + 10) + 'px';
            
            // Update Data
            document.getElementById(`likes-${b.id}`).innerText = b.likes;

            // Visual States
            if(b.isWinner) el.classList.add('winner');
            else el.classList.remove('winner');
            
            // Highlight logic for animation can be added here
        }

        // --- PHYSICS LOOP (Teacher Only) ---
        function startPhysicsLoop() {
            function loop() {
                updatePhysics();
                drawThreads();
                broadcastState(); // Network Tick
                requestAnimationFrame(loop);
            }
            loop();
        }

        function startClientPhysics() {
            function loop() {
                bubbles.forEach(b => updateBubbleDOM(b));
                drawThreads();
                requestAnimationFrame(loop);
            }
            loop();
        }

        function updatePhysics() {
            const centerX = width / 2;
            const centerY = height / 2;

            bubbles.forEach((b, i) => {
                if(b.isWinner) return; // Winner stays put

                // 1. Forces
                let fx = 0, fy = 0;

                // Gravity (Pull to center) - Weak Cohesion
                fx += (centerX - b.x) * 0.0005;
                fy += (centerY - b.y) * 0.0005;

                // Repulsion (Separation)
                bubbles.forEach((other, j) => {
                    if (i === j) return;
                    const dx = b.x - other.x;
                    const dy = b.y - other.y;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    const minDist = b.radius + other.radius + 10; // +10 buffer

                    if (dist < minDist && dist > 0) {
                        const force = (minDist - dist) * 0.05; // Strong repulsion
                        fx += (dx / dist) * force;
                        fy += (dy / dist) * force;
                    }
                });

                // Spring Force (Replies pull to Parent)
                if (b.parentId) {
                    const parent = bubbles.find(p => p.id === b.parentId);
                    if (parent) {
                        const dx = parent.x - b.x;
                        const dy = parent.y - b.y;
                        const dist = Math.sqrt(dx*dx + dy*dy);
                        const targetDist = parent.radius + b.radius + 20;
                        // Pull towards ideal distance
                        if (dist > targetDist) {
                            fx += dx * 0.002;
                            fy += dy * 0.002;
                        }
                    }
                }

                // Apply
                b.vx = (b.vx + fx) * 0.9; // Friction
                b.vy = (b.vy + fy) * 0.9;
                b.x += b.vx;
                b.y += b.vy;

                // Bounds
                if(b.x < 0) b.x = 0; if(b.x > width) b.x = width;
                if(b.y < 0) b.y = 0; if(b.y > height) b.y = height;

                updateBubbleDOM(b);
            });
        }

        function drawThreads() {
            ctx.clearRect(0, 0, width, height);
            ctx.strokeStyle = '#b2bec3';
            ctx.lineWidth = 2;

            bubbles.forEach(b => {
                if(b.parentId) {
                    const parent = bubbles.find(p => p.id === b.parentId);
                    if(parent) {
                        ctx.beginPath();
                        ctx.moveTo(b.x, b.y);
                        ctx.lineTo(parent.x, parent.y);
                        ctx.stroke();
                    }
                }
            });
        }

        // --- INTERACTION LOGIC ---
        function sendLike(id) {
            // Optimistic update
            const b = bubbles.find(x => x.id === id);
            if(b) b.likes++; 
            
            if(role === 'student') hostConn.send({ type: 'LIKE', id });
            else broadcastState();
        }

        function openReply(id, name) {
            activeReplyParentId = id;
            document.getElementById('reply-target-name').innerText = name;
            document.getElementById('reply-modal').style.display = 'flex';
        }

        function closeReplyModal() {
            document.getElementById('reply-modal').style.display = 'none';
            document.getElementById('reply-input').value = '';
        }

        function sendReply() {
            const txt = document.getElementById('reply-input').value;
            if(!txt) return;

            if(role === 'student') {
                hostConn.send({ type: 'REPLY', text: txt, author: window.studentName, parentId: activeReplyParentId });
            } else {
                createBubble(txt, "Teacher", activeReplyParentId);
            }
            closeReplyModal();
        }

        // --- ROULETTE ANIMATION ---
        function startRoulette() {
            const candidates = bubbles.filter(b => !b.isWinner);
            if(candidates.length === 0) return alert("No bubbles left!");

            let cycles = 0;
            const maxCycles = 20;
            let speed = 100;
            
            // Reset old winners visual
            bubbles.forEach(b => { 
                b.isWinner = false; 
                document.getElementById('dom-'+b.id)?.classList.remove('winner');
            });

            function step() {
                // Clear highlights
                document.querySelectorAll('.bubble').forEach(el => el.classList.remove('highlight'));
                
                // Pick random temp
                const rand = candidates[Math.floor(Math.random() * candidates.length)];
                const el = document.getElementById('dom-'+rand.id);
                if(el) el.classList.add('highlight');

                cycles++;
                if(cycles < maxCycles) {
                    setTimeout(step, speed);
                } else {
                    // Final Winner
                    rand.isWinner = true;
                    broadcastState();
                    
                    // Center it visually (Teacher physics handles this usually, but let's force a push)
                    rand.vx = (width/2 - rand.x) * 0.1;
                    rand.vy = (height/2 - rand.y) * 0.1;
                }
            }
            step();
        }

    </script>
</body>
</html>
