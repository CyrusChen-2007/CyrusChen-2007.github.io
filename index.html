<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>First Five | Connected Classroom</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/peerjs@1.5.1/dist/peerjs.min.js"></script>

    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
            --text-main: #2d3436;
            --accent: #6c5ce7; 
            --accent-light: #a29bfe;
            --thread-color: #b2bec3;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: #f0f2f5; 
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            width: 100vw; height: 100vh;
        }

        /* --- VIVACIOUS BACKGROUND --- */
        .orb {
            position: absolute; border-radius: 50%; filter: blur(90px); opacity: 0.6; z-index: -1;
            animation: floatOrb 20s infinite ease-in-out;
            pointer-events: none;
        }
        .orb-1 { top: -10%; left: -10%; width: 50vw; height: 50vw; background: #ff9a9e; animation-delay: 0s; }
        .orb-2 { bottom: -20%; right: -10%; width: 60vw; height: 60vw; background: #a18cd1; animation-delay: -5s; }
        .orb-3 { top: 40%; left: 40%; width: 40vw; height: 40vw; background: #fad0c4; animation-delay: -10s; }

        @keyframes floatOrb {
            0%, 100% { transform: translate(0, 0); }
            50% { transform: translate(30px, -50px); }
        }

        /* --- LAYOUT LAYERS (Z-INDEX FIX) --- */
        
        /* 1. The Universe (Bubbles) - Bottom Layer */
        #universe-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1; /* FIXED: Lower than screen */
            pointer-events: none; /* Allows clicking through empty space */
            display: none; /* Hidden by default for students */
        }

        #thread-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0; 
            pointer-events: none;
            display: none;
        }

        /* 2. The Screens (Input Box, Login) - Top Layer */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.5s ease;
            z-index: 10; /* FIXED: Higher than bubbles */
        }
        .screen.active { opacity: 1; pointer-events: auto; }

        h1 { font-family: 'DM Serif Display', serif; font-size: 3.5rem; margin-bottom: 1rem; }
        
        .card {
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(20px);
            padding: 3rem; border-radius: 24px;
            border: 1px solid rgba(255,255,255,0.8);
            box-shadow: 0 20px 40px rgba(0,0,0,0.05);
            display: flex; flex-direction: column; align-items: center; gap: 1.5rem;
            max-width: 500px; width: 90%;
            text-align: center;
            /* Ensure card blocks bubbles visually if they were visible */
            z-index: 11; 
        }

        input, textarea {
            background: rgba(255,255,255,0.6); border: 1px solid rgba(0,0,0,0.1);
            border-radius: 12px; padding: 12px; font-size: 1rem; width: 100%;
            font-family: inherit; outline: none; transition: 0.3s;
        }
        input:focus, textarea:focus { background: white; border-color: var(--accent); }
        textarea { height: 120px; resize: none; }

        button {
            background: var(--text-main); color: white; border: none;
            padding: 12px 30px; border-radius: 50px; font-size: 1rem; font-weight: 600;
            cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        button.secondary { background: white; color: var(--text-main); border: 1px solid #ddd; }
        button.small { padding: 6px 12px; font-size: 0.8rem; }

        /* --- BUBBLE STYLES --- */
        .bubble {
            position: absolute;
            width: fit-content; max-width: 280px; min-width: 120px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.05);
            text-align: left;
            pointer-events: auto; /* Re-enable clicks on bubbles */
            transform-origin: center;
            will-change: transform, left, top;
            display: flex; flex-direction: column; gap: 8px;
            transition: background 0.3s, border 0.3s;
        }

        .bubble-text { font-size: 0.95rem; line-height: 1.4; color: #2d3436; word-wrap: break-word; }
        .bubble-meta { 
            display: flex; justify-content: space-between; align-items: center; 
            font-size: 0.75rem; color: #636e72; border-top: 1px solid rgba(0,0,0,0.05); 
            padding-top: 8px; margin-top: 4px;
        }
        .bubble-author { font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--accent); }
        
        .bubble-actions { display: flex; gap: 10px; }
        .action-btn { 
            cursor: pointer; display: flex; align-items: center; gap: 4px; 
            transition: color 0.2s; background: none; border: none; padding: 0; color: #b2bec3; font-size: 0.8rem;
        }
        .action-btn:hover { color: var(--accent); }
        .action-btn.liked { color: #e17055; }

        .bubble.reply {
            background: rgba(240, 240, 255, 0.65);
            border-color: var(--accent-light);
            font-size: 0.9rem; max-width: 220px;
        }

        .bubble.highlight { border: 2px solid var(--accent); background: white; z-index: 100; transform: scale(1.1); }
        .bubble.winner { 
            border: 3px solid var(--accent); background: white; 
            box-shadow: 0 0 60px rgba(108, 92, 231, 0.4);
            z-index: 200;
        }

        /* --- UI OVERLAYS (HUD) --- */
        .hud-bar {
            position: fixed; z-index: 50; padding: 15px 25px;
            background: rgba(255,255,255,0.85); backdrop-filter: blur(15px);
            border-radius: 16px; border: 1px solid white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            display: flex; gap: 20px; align-items: center;
            flex-wrap: wrap; 
            height: auto;
            max-width: 90vw;
        }
        
        /* Teacher Top Bar */
        #teacher-hud { top: 20px; left: 50%; transform: translateX(-50%); justify-content: center; }
        
        /* Student Top Bar */
        #student-hud { top: 20px; left: 50%; transform: translateX(-50%); width: 80%; max-width: 800px; justify-content: center; text-align: center; }

        .divider { width: 1px; height: 30px; background: #ddd; }
        
        .prompt-display-text { 
            font-family: 'DM Serif Display', serif; 
            font-size: 1.3rem; 
            width: 100%;
            text-align: center;
            white-space: normal;
            color: var(--text-main);
            margin-top: 10px;
        }

        .hud-controls { display: flex; gap: 20px; align-items: center; }

        /* Reply Modal */
        #reply-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.2); backdrop-filter: blur(5px);
            z-index: 1000; display: none; align-items: center; justify-content: center;
        }

    </style>
</head>
<body>

    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>
    <div class="orb orb-3"></div>

    <canvas id="thread-canvas"></canvas>
    
    <div id="universe-layer"></div>

    <div id="screen-landing" class="screen active">
        <div class="card">
            <h1>First Five</h1>
            <p>Interactive Literature Response Tool</p>
            <div style="display: flex; gap: 15px; margin-top: 20px;">
                <button onclick="initTeacher()">Host Class</button>
                <button class="secondary" onclick="router('student-login')">Join Class</button>
            </div>
        </div>
    </div>

    <div id="screen-student-login" class="screen">
        <div class="card">
            <h2>Join Room</h2>
            <input type="text" id="join-code" placeholder="4-Digit Code" maxlength="4" style="text-align: center; font-size: 1.5rem; letter-spacing: 4px;">
            <input type="text" id="student-name" placeholder="Your Name">
            <button onclick="joinSession()">Enter</button>
            <button class="secondary" onclick="router('landing')">Back</button>
        </div>
    </div>

    <div id="screen-writing" class="screen">
        <div class="card">
            <h3 style="color: var(--accent); text-transform: uppercase; font-size: 0.8rem;">Current Prompt</h3>
            <h2 id="student-prompt-view" style="font-family: 'DM Serif Display'; font-size: 1.5rem;">Waiting for teacher...</h2>
            <textarea id="student-response" placeholder="Write your response..."></textarea>
            <button onclick="submitResponse()">Publish to Class</button>
        </div>
    </div>

    <div id="screen-universe" class="screen">
        
        <div id="teacher-hud" class="hud-bar" style="display: none;">
            
            <div class="hud-controls">
                <div>
                    <span style="font-size: 0.7rem; color: #888; text-transform: uppercase;">Code</span>
                    <strong id="display-code" style="font-size: 1.2rem; color: var(--accent); margin-left: 5px;">----</strong>
                </div>
                
                <div class="divider"></div>

                <div id="t-prompt-input-group" style="display: flex; gap: 5px;">
                    <input type="text" id="teacher-input" placeholder="Set Prompt..." style="width: 200px;">
                    <button class="secondary small" onclick="setPrompt()">Set</button>
                </div>
                <div id="t-prompt-edit-btn" style="display: none;">
                    <button class="secondary small" onclick="editPrompt()">✎ Edit</button>
                </div>

                <div class="divider"></div>

                <div style="display: flex; align-items: center; gap: 5px;">
                    <input type="number" id="timer-input" value="5" min="1" max="60" style="width: 50px; padding: 5px;">
                    <button class="small" onclick="startTimer()">▶</button>
                    <span id="timer-display" style="font-family: 'DM Serif Display'; font-size: 1.2rem; min-width: 50px;">05:00</span>
                </div>

                <div class="divider"></div>
                
                <button class="small" style="background: var(--accent);" onclick="startRoulette()">✦ Pick</button>
            </div>

            <div id="t-prompt-display-group" style="display: none; width: 100%; border-top: 1px solid #eee; padding-top: 10px; margin-top: 5px;">
                <div id="t-prompt-text" class="prompt-display-text">...</div>
            </div>

        </div>

        <div id="student-hud" class="hud-bar" style="display: none;">
            <div style="display: flex; flex-direction: column; align-items: center;">
                <span style="font-size: 0.7rem; color: var(--accent); text-transform: uppercase;">The Prompt</span>
                <span id="s-universe-prompt" style="font-family: 'DM Serif Display'; font-size: 1.2rem; line-height: 1.2;">Waiting for prompt...</span>
            </div>
        </div>

    </div>

    <div id="reply-modal">
        <div class="card">
            <h3>Reply to <span id="reply-target-name">...</span></h3>
            <textarea id="reply-input" placeholder="Your thoughts..."></textarea>
            <div style="display: flex; gap: 10px; width: 100%;">
                <button onclick="sendReply()" style="flex: 1;">Post Reply</button>
                <button class="secondary" onclick="closeReplyModal()" style="flex: 1;">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG & STATE ---
        const APP_ID = 'inkwell-v5-final-';
        let myPeer, myId;
        let role = 'student'; 
        let connections = []; 
        let hostConn = null;  
        
        let bubbles = []; 
        let currentPrompt = "";
        
        let physicsLoopId;
        const canvas = document.getElementById('thread-canvas');
        const ctx = canvas.getContext('2d');
        let width, height;

        let activeReplyParentId = null;

        // --- ROUTING ---
        function router(screen) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(`screen-${screen}`).classList.add('active');
        }

        // --- RESIZE HANDLER ---
        function resize() {
            width = window.innerWidth;
            height = window.innerHeight;
            canvas.width = width;
            canvas.height = height;
        }
        window.addEventListener('resize', resize);
        resize();

        // --- VISIBILITY HELPERS ---
        function showUniverse() {
            document.getElementById('universe-layer').style.display = 'block';
            document.getElementById('thread-canvas').style.display = 'block';
        }

        // --- TEACHER LOGIC ---
        function initTeacher() {
            role = 'teacher';
            const code = Math.floor(1000 + Math.random() * 9000).toString();
            myPeer = new Peer(APP_ID + code);

            myPeer.on('open', (id) => {
                myId = id;
                document.getElementById('display-code').innerText = code;
                document.getElementById('teacher-hud').style.display = 'flex';
                
                // Teacher sees universe immediately
                showUniverse();
                router('universe');
                
                startPhysicsLoop(); 
            });

            myPeer.on('connection', (conn) => {
                connections.push(conn);
                conn.on('data', (data) => handleServerData(data, conn));
                
                setTimeout(() => {
                    conn.send({ type: 'SYNC_FULL', bubbles: bubbles, prompt: currentPrompt });
                }, 500);
            });
        }

        function handleServerData(data, conn) {
            if(data.type === 'SUBMIT') {
                createBubble(data.text, data.author, null); 
            }
            if(data.type === 'REPLY') {
                createBubble(data.text, data.author, data.parentId);
            }
            if(data.type === 'LIKE') {
                const b = bubbles.find(b => b.id === data.id);
                if(b) {
                    b.likes++;
                    broadcastState();
                }
            }
        }

        // Prompt Logic
        function setPrompt() {
            const txt = document.getElementById('teacher-input').value;
            if(!txt) return;
            currentPrompt = txt;
            
            // UI Toggle
            document.getElementById('t-prompt-input-group').style.display = 'none';
            document.getElementById('t-prompt-display-group').style.display = 'block';
            document.getElementById('t-prompt-edit-btn').style.display = 'block';
            document.getElementById('t-prompt-text').innerText = txt;

            broadcast({ type: 'PROMPT', text: currentPrompt });
        }

        function editPrompt() {
            document.getElementById('t-prompt-display-group').style.display = 'none';
            document.getElementById('t-prompt-edit-btn').style.display = 'none';
            document.getElementById('t-prompt-input-group').style.display = 'flex';
        }

        // Timer Logic
        let timerInterval;
        function startTimer() {
            const input = document.getElementById('timer-input');
            let time = parseInt(input.value) * 60;
            
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                time--;
                let m = Math.floor(time / 60);
                let s = time % 60;
                document.getElementById('timer-display').innerText = 
                    `${m}:${s < 10 ? '0' : ''}${s}`;
                
                if(time <= 0) {
                    clearInterval(timerInterval);
                    document.getElementById('timer-display').style.color = 'red';
                }
            }, 1000);
        }

        function broadcastState() {
            const payload = bubbles.map(b => ({
                id: b.id, x: b.x, y: b.y, 
                text: b.text, author: b.author, 
                likes: b.likes, parentId: b.parentId,
                isWinner: b.isWinner
            }));
            broadcast({ type: 'SYNC_TICK', bubbles: payload });
        }

        function broadcast(msg) {
            connections.forEach(c => c.send(msg));
        }

        // --- STUDENT LOGIC ---
        function joinSession() {
            const code = document.getElementById('join-code').value;
            const name = document.getElementById('student-name').value;
            if(!code || !name) return alert("Missing Code/Name");
            
            window.studentName = name;

            myPeer = new Peer();
            myPeer.on('open', () => {
                hostConn = myPeer.connect(APP_ID + code);
                hostConn.on('open', () => {
                    router('writing');
                });
                hostConn.on('data', handleClientData);
            });
        }

        function handleClientData(data) {
            if(data.type === 'PROMPT') {
                currentPrompt = data.text;
                document.getElementById('student-prompt-view').innerText = currentPrompt;
                document.getElementById('s-universe-prompt').innerText = currentPrompt;
            }
            if(data.type === 'SYNC_FULL') {
                currentPrompt = data.prompt;
                document.getElementById('student-prompt-view').innerText = currentPrompt;
                document.getElementById('s-universe-prompt').innerText = currentPrompt;
                
                // We sync bubbles, but they remain hidden via CSS until submitResponse()
                data.bubbles.forEach(remoteB => {
                   if(!bubbles.find(b => b.id === remoteB.id)) {
                       spawnLocalBubble(remoteB);
                   } 
                });
            }
            if(data.type === 'SYNC_TICK') {
                data.bubbles.forEach(remoteB => {
                    let localB = bubbles.find(b => b.id === remoteB.id);
                    if(!localB) {
                        spawnLocalBubble(remoteB);
                    } else {
                        localB.targetX = remoteB.x;
                        localB.targetY = remoteB.y;
                        localB.likes = remoteB.likes;
                        localB.isWinner = remoteB.isWinner;
                        updateBubbleDOM(localB);
                    }
                });
            }
        }

        function submitResponse() {
            const txt = document.getElementById('student-response').value;
            if(!txt) return;
            hostConn.send({ type: 'SUBMIT', text: txt, author: window.studentName });
            
            router('universe');
            document.getElementById('student-hud').style.display = 'flex';
            
            // REVEAL UNIVERSE
            showUniverse();

            document.getElementById('s-universe-prompt').innerText = currentPrompt || "Joined Class";
            startClientPhysics(); 
        }

        // --- SHARED PHYSICS ---

        function createBubble(text, author, parentId) {
            const id = Date.now() + Math.random().toString();
            let startX, startY;
            
            if (parentId) {
                const parent = bubbles.find(b => b.id === parentId);
                startX = parent ? parent.x + (Math.random()-0.5)*50 : width/2;
                startY = parent ? parent.y + 50 : height/2;
            } else {
                const angle = Math.random() * Math.PI * 2;
                const dist = Math.min(width, height) / 2 + 100;
                startX = width/2 + Math.cos(angle) * dist;
                startY = height/2 + Math.sin(angle) * dist;
            }

            const newBubble = {
                id, text, author, parentId,
                x: startX, y: startY,
                vx: 0, vy: 0,
                radius: 60,
                likes: 0,
                isWinner: false
            };
            
            bubbles.push(newBubble);
            spawnBubbleDOM(newBubble);
            broadcastState();
        }

        function spawnLocalBubble(data) {
            const b = { ...data, vx:0, vy:0, targetX: data.x, targetY: data.y };
            bubbles.push(b);
            spawnBubbleDOM(b);
        }

        function spawnBubbleDOM(b) {
            const el = document.createElement('div');
            el.className = b.parentId ? 'bubble reply' : 'bubble';
            el.id = 'dom-' + b.id;
            
            const content = `
                <div class="bubble-text">${b.text}</div>
                <div class="bubble-meta">
                    <span class="bubble-author">${b.author}</span>
                    <div class="bubble-actions">
                        <button class="action-btn" onclick="sendLike('${b.id}')">
                            ♥ <span id="likes-${b.id}">${b.likes}</span>
                        </button>
                        <button class="action-btn" onclick="openReply('${b.id}', '${b.author}')">
                            ↰ Reply
                        </button>
                    </div>
                </div>
            `;
            el.innerHTML = content;
            document.getElementById('universe-layer').appendChild(el);
            
            const rect = el.getBoundingClientRect();
            b.radius = Math.max(rect.width, rect.height) / 2 + 10;
        }

        function updateBubbleDOM(b) {
            const el = document.getElementById('dom-' + b.id);
            if(!el) return;
            
            if(role === 'student') {
                b.x += (b.targetX - b.x) * 0.1;
                b.y += (b.targetY - b.y) * 0.1;
            }

            el.style.left = (b.x - b.radius + 10) + 'px';
            el.style.top = (b.y - b.radius + 10) + 'px';
            document.getElementById(`likes-${b.id}`).innerText = b.likes;

            if(b.isWinner) el.classList.add('winner');
            else el.classList.remove('winner');
        }

        // --- PHYSICS LOOPS ---
        function startPhysicsLoop() {
            function loop() {
                updatePhysics();
                drawThreads();
                broadcastState();
                requestAnimationFrame(loop);
            }
            loop();
        }

        function startClientPhysics() {
            function loop() {
                bubbles.forEach(b => updateBubbleDOM(b));
                drawThreads();
                requestAnimationFrame(loop);
            }
            loop();
        }

        function updatePhysics() {
            const centerX = width / 2;
            const centerY = height / 2;

            bubbles.forEach((b, i) => {
                if(b.isWinner) return; 

                let fx = 0, fy = 0;

                fx += (centerX - b.x) * 0.0005;
                fy += (centerY - b.y) * 0.0005;

                bubbles.forEach((other, j) => {
                    if (i === j) return;
                    const dx = b.x - other.x;
                    const dy = b.y - other.y;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    const minDist = b.radius + other.radius + 10; 

                    if (dist < minDist && dist > 0) {
                        const force = (minDist - dist) * 0.05; 
                        fx += (dx / dist) * force;
                        fy += (dy / dist) * force;
                    }
                });

                if (b.parentId) {
                    const parent = bubbles.find(p => p.id === b.parentId);
                    if (parent) {
                        const dx = parent.x - b.x;
                        const dy = parent.y - b.y;
                        const dist = Math.sqrt(dx*dx + dy*dy);
                        const targetDist = parent.radius + b.radius + 20;
                        if (dist > targetDist) {
                            fx += dx * 0.002;
                            fy += dy * 0.002;
                        }
                    }
                }

                b.vx = (b.vx + fx) * 0.9; 
                b.vy = (b.vy + fy) * 0.9;
                b.x += b.vx;
                b.y += b.vy;

                if(b.x < 0) b.x = 0; if(b.x > width) b.x = width;
                if(b.y < 0) b.y = 0; if(b.y > height) b.y = height;

                updateBubbleDOM(b);
            });
        }

        function drawThreads() {
            ctx.clearRect(0, 0, width, height);
            ctx.strokeStyle = '#b2bec3';
            ctx.lineWidth = 2;

            bubbles.forEach(b => {
                if(b.parentId) {
                    const parent = bubbles.find(p => p.id === b.parentId);
                    if(parent) {
                        ctx.beginPath();
                        ctx.moveTo(b.x, b.y);
                        ctx.lineTo(parent.x, parent.y);
                        ctx.stroke();
                    }
                }
            });
        }

        // --- INTERACTIONS ---
        function sendLike(id) {
            const b = bubbles.find(x => x.id === id);
            if(b) b.likes++; 
            if(role === 'student') hostConn.send({ type: 'LIKE', id });
            else broadcastState();
        }

        function openReply(id, name) {
            activeReplyParentId = id;
            document.getElementById('reply-target-name').innerText = name;
            document.getElementById('reply-modal').style.display = 'flex';
        }

        function closeReplyModal() {
            document.getElementById('reply-modal').style.display = 'none';
            document.getElementById('reply-input').value = '';
        }

        function sendReply() {
            const txt = document.getElementById('reply-input').value;
            if(!txt) return;

            if(role === 'student') {
                hostConn.send({ type: 'REPLY', text: txt, author: window.studentName, parentId: activeReplyParentId });
            } else {
                createBubble(txt, "Teacher", activeReplyParentId);
            }
            closeReplyModal();
        }

        // --- ROULETTE LOGIC ---
        function startRoulette() {
            const candidates = bubbles.filter(b => !b.isWinner && !b.parentId);
            
            if(candidates.length === 0) {
                const allMainBubbles = bubbles.filter(b => !b.parentId);
                if(allMainBubbles.length > 0) {
                    alert("All responses have been chosen! Starting new cycle.");
                    bubbles.forEach(b => { 
                        b.isWinner = false; 
                        document.getElementById('dom-'+b.id)?.classList.remove('winner');
                    });
                    broadcastState();
                } else {
                    alert("No responses to pick from!");
                }
                return;
            }

            let cycles = 0;
            const maxCycles = 20;
            let speed = 100;
            
            bubbles.forEach(b => { 
                document.getElementById('dom-'+b.id)?.classList.remove('highlight');
            });

            function step() {
                document.querySelectorAll('.bubble').forEach(el => el.classList.remove('highlight'));
                
                const rand = candidates[Math.floor(Math.random() * candidates.length)];
                const el = document.getElementById('dom-'+rand.id);
                if(el) el.classList.add('highlight');

                cycles++;
                if(cycles < maxCycles) {
                    setTimeout(step, speed);
                } else {
                    rand.isWinner = true;
                    broadcastState();
                    rand.vx = (width/2 - rand.x) * 0.1;
                    rand.vy = (height/2 - rand.y) * 0.1;
                }
            }
            step();
        }
    </script>
</body>
</html>
